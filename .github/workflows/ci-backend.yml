name: CI Backend (NestJS)

on:
  push:
    branches: [ main, qa ]
  pull_request:
    branches: [ main, qa ]

concurrency:
  group: ci-backend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: CI for QuickPass BackEnd (IngenioAPI)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies (npm ci)
        run: npm ci

      # Prettier: tu script "format" escribe, así que en CI hacemos "check"
      - name: Prettier check
        run: npx prettier --check "src/**/*.ts" "test/**/*.ts" "*.md" "*.json"

      # ESLint: tu script "lint" usa --fix; en CI NO queremos auto-fix.
      # Esto falla si hay warnings (max-warnings=0).
      - name: ESLint (no warnings)
        run: npx eslint "{src,apps,libs,test}/**/*.ts" --max-warnings=0

      - name: Unit tests with coverage
        run: npm run test:cov -- --runInBand

      - name: Build
        run: npm run build

  e2e:
    name: E2E Tests (with MSSQL service)
    runs-on: ubuntu-latest
    needs: quality

    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: "Y"
          MSSQL_SA_PASSWORD: ${{ secrets.CI_MSSQL_SA_PASSWORD }}
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P $MSSQL_SA_PASSWORD -C -Q 'SELECT 1' || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # Crea la DB "ingenioapi" si no existe, usando el paquete mssql (ya lo tienes en deps)
      - name: Create database (ingenioapi)
        env:
          MSSQL_SA_PASSWORD: ${{ secrets.CI_MSSQL_SA_PASSWORD }}
        run: |
          node -e "const sql=require('mssql');
          (async()=>{
            const cfg={user:'sa',password:process.env.MSSQL_SA_PASSWORD,server:'localhost',port:1433,options:{encrypt:false,trustServerCertificate:true}};
            await sql.connect(cfg);
            await sql.query(\"IF DB_ID('ingenioapi') IS NULL CREATE DATABASE ingenioapi;\");
            await sql.close();
            console.log('DB ready');
          })().catch(e=>{console.error(e);process.exit(1);});"

      - name: Run e2e tests
        env:
          NODE_ENV: test
          TIMEZONE: America/El_Salvador

          # DB (TypeORM/Nest)
          DATABASE_TYPE: mssql
          DATABASE_HOST: localhost
          DATABASE_PORT: "1433"
          DATABASE_USERNAME: sa
          DATABASE_PASSWORD: ${{ secrets.CI_MSSQL_SA_PASSWORD }}
          DATABASE_NAME: ingenioapi

          # Requeridos por tu código (ponemos dummy para CI)
          JWT_SECRET: "ci_dummy_secret"
          FRONTEND_ORIGIN_PROD: "http://localhost:3000"
          MEDIA_URL_SECRET: "ci_media_secret"
          MEDIA_URL_TTL_SECONDS: "3600"
          MIDDLEWARE_AUTH_KEY: "ci_dummy_key"
          MW_UPDATE_TEMP_URL: "http://localhost/"
          NAV_TEMP_MAX: "999"

          SERVER_MIDDLEWARE_NAME: "http://localhost/"
          SERVER_MIDDLEWARE_CREATE: "http://localhost/"
          SERVER_MIDDLEWARE_GET: "http://localhost/"
          SERVER_MIDDLEWARE_SYSTEM_CONTROL: "http://localhost/"
          SERVER_MIDDLEWARE_UPDATE_TEMPERATURE: "http://localhost/"
          SERVER_MIDDLEWARE_UPDATE_HUMIDITY: "http://localhost/"
          SERVER_MIDDLEWARE_UPDATE_MAGNETIC_CARD: "http://localhost/"
          SERVER_MIDDLEWARE_UPDATE_PESO_CLIENTE: "http://localhost/"
          SERVER_MIDDLEWARE_UPDATE_STATUS_LEVERANS: "http://localhost/"
          SERVER_MIDDLEWARE_UPDATE_WAREHOUSE: "http://localhost/"
          SERVER_MIDDLEWARE_START_MONITORING_SYSTEM: "http://localhost/"
          SERVER_MIDDLEWARE_STOP_MONITORING_SYSTEM: "http://localhost/"
          SERVER_MIDDLEWARE_RESTART_MONITORING_SYSTEM: "http://localhost/"
          SERVER_MIDDLEWARE_CREATE_LEVERANS: "http://localhost/"
          SERVER_EXCALIBUR_NAME: "http://localhost/"
        run: npm run test:e2e -- --runInBand
