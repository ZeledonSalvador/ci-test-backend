name: CI Backend (NestJS)

on:
  push:
    branches: [ main, qa ]
  pull_request:
    branches: [ main, qa ]

concurrency:
  group: ci-backend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: CI for QuickPass BackEnd (IngenioAPI)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4

      # 0) Timer (para medir TOTAL incluyendo POST)
      - name: Start CI timer
        uses: ./.github/actions/ci-timer

      - name: Setup Node
        id: setup_node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies (npm ci)
        id: install
        run: npm ci --legacy-peer-deps

      # Prettier: check sin escribir
      - name: Prettier check
        id: prettier
        run: |
          set +e
          npx prettier --check "src/**/*.ts" "test/**/*.ts" "*.md" "*.json"
          code=$?
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit 0

      # ESLint: generar reporte JSON para contar warnings/errors en el summary
      - name: ESLint (max 100 warnings)
        id: eslint
        run: |
          set +e
          npx eslint "{src,apps,libs,test}/**/*.ts" --max-warnings=100 -f json -o eslint-report.json
          code=$?
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Build
        id: build
        run: |
          set +e
          npm run build
          code=$?
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit 0

      # Artifact del reporte ESLint
      - name: Upload ESLint report (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-report
          path: eslint-report.json
          if-no-files-found: ignore

      # Summary visual (antes de los POST steps)
      - name: Build Job Summary (visual)
        if: always()
        id: summary
        env:
          PRETTIER_CODE: ${{ steps.prettier.outputs.exit_code }}
          ESLINT_CODE: ${{ steps.eslint.outputs.exit_code }}
          BUILD_CODE: ${{ steps.build.outputs.exit_code }}
          ACTOR: ${{ github.actor }}
          EVENT_NAME: ${{ github.event_name }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref }}
          SHA: ${{ github.sha }}
          RUN_ID: ${{ github.run_id }}
          WORKFLOW_NAME: ${{ github.workflow }}
        run: |
          set -euo pipefail

          # Marca el fin de los steps "normales" (pre-POST)
          end_prepost_ms=$(date +%s%3N)
          echo "$end_prepost_ms" > .ci_end_prepost_ms

          start_ms="${CI_START_EPOCH_MS}"
          pre_ms=$((end_prepost_ms - start_ms))

          fmt() {
            local ms="$1"
            local sec=$((ms/1000))
            local min=$((sec/60))
            local rem=$((sec%60))
            printf "%d:%02d" "$min" "$rem"
          }

          # Hora inicio (UTC y El Salvador)
          start_utc="${CI_START_ISO}"
          start_sv="$(TZ=America/El_Salvador date -d "${CI_START_ISO}" '+%Y-%m-%d %H:%M:%S %Z' || true)"
          run_url="https://github.com/${REPO}/actions/runs/${RUN_ID}"

          # Parse ESLint report (warnings/errors)
          eslint_warnings="N/A"
          eslint_errors="N/A"
          if [ -f eslint-report.json ]; then
            read -r eslint_warnings eslint_errors < <(node -e "
              const fs = require('fs');
              const p = 'eslint-report.json';
              const raw = fs.readFileSync(p, 'utf8');
              const arr = JSON.parse(raw);
              let warnings = 0, errors = 0;
              for (const f of arr) {
                warnings += (f.warningCount || 0);
                errors += (f.errorCount || 0);
              }
              process.stdout.write(\\\`\\\${warnings} \\\${errors}\\\`);
            ")
          fi

          # Funci√≥n helper para iconos de status
          status_icon() {
            local code="$1"
            if [ "$code" = "0" ]; then echo "‚úÖ OK"; else echo "‚ùå FAIL"; fi
          }

          prettier_status="$(status_icon "${PRETTIER_CODE:-1}")"
          eslint_status="$(status_icon "${ESLINT_CODE:-1}")"
          build_status="$(status_icon "${BUILD_CODE:-1}")"

          {
            echo "# üìã CI Summary ‚Äî ${WORKFLOW_NAME}"
            echo ""
            echo "## üë§ Metadata"
            echo ""
            echo "| Campo | Valor |"
            echo "|---|---|"
            echo "| Usuario (actor) | \`${ACTOR}\` |"
            echo "| Evento | \`${EVENT_NAME}\` |"
            echo "| Repo | \`${REPO}\` |"
            echo "| Ref | \`${REF}\` |"
            echo "| Commit | \`${SHA}\` |"
            echo "| Inicio (UTC) | \`${start_utc}\` |"
            echo "| Inicio (El Salvador) | \`${start_sv}\` |"
            echo "| Duraci√≥n (pre-POST) | \`$(fmt "$pre_ms")\` |"
            echo "| Run | ${run_url} |"
            echo ""
            echo "## ‚úÖ Pasos ejecutados y resultados"
            echo ""
            echo "| Paso | Resultado | Detalle |"
            echo "|---|---:|---|"
            echo "| Checkout | ‚úÖ OK | actions/checkout@v4 |"
            echo "| Setup Node | ‚úÖ OK | Node 18 + cache npm |"
            echo "| Install deps | ‚úÖ OK | npm ci --legacy-peer-deps |"
            echo "| Prettier | ${prettier_status} | exit_code=${PRETTIER_CODE:-N/A} |"
            echo "| ESLint | ${eslint_status} | warnings=${eslint_warnings}, errors=${eslint_errors}, exit_code=${ESLINT_CODE:-N/A} |"
            echo "| Build | ${build_status} | exit_code=${BUILD_CODE:-N/A} |"
            echo ""
            echo "## üì¶ Artifacts"
            echo ""
            echo "- \`eslint-report\` (eslint-report.json) ‚Äî **si existe, queda adjunto en esta run**."
            echo ""
            echo "## üß© Diagn√≥stico r√°pido"
            echo ""
            if [ "${PRETTIER_CODE:-1}" != "0" ]; then
              echo "- ‚ùå **Prettier fall√≥**: hay archivos que no cumplen formato (usa `npm run format` localmente o corre prettier)."
            else
              echo "- ‚úÖ Prettier pas√≥."
            fi

            if [ "${ESLINT_CODE:-1}" != "0" ]; then
              echo "- ‚ùå **ESLint fall√≥**: revisar el artifact `eslint-report` y/o reducir warnings (l√≠mite: 100)."
            else
              echo "- ‚úÖ ESLint pas√≥ dentro del l√≠mite de warnings."
            fi

            if [ "${BUILD_CODE:-1}" != "0" ]; then
              echo "- ‚ùå **Build fall√≥**: el proyecto no compil√≥."
            else
              echo "- ‚úÖ Build pas√≥."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      # Gate final: si algo fall√≥, el job debe fallar (pero ya dejamos Summary)
      - name: Fail job if quality checks failed
        if: always()
        run: |
          failures=0
          [ "${{ steps.prettier.outputs.exit_code }}" = "0" ] || failures=1
          [ "${{ steps.eslint.outputs.exit_code }}" = "0" ] || failures=1
          [ "${{ steps.build.outputs.exit_code }}" = "0" ] || failures=1
          exit $failures
