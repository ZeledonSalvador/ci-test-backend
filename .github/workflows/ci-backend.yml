# Nombre del workflow (así aparece en la pestaña "Actions" de GitHub)
name: CI Backend (NestJS)

# Define cuándo se ejecuta este workflow
on:
  # Se ejecuta cuando hay un push a estas ramas
  push:
    branches: [ main, qa ]
  # Se ejecuta cuando se crea/actualiza un Pull Request hacia estas ramas
  pull_request:
    branches: [ main, qa ]

# Evita que se ejecuten varios runs del mismo workflow a la vez para la misma referencia (rama/commit)
concurrency:
  # Agrupa ejecuciones por referencia (por ejemplo: refs/heads/main o refs/pull/123/merge)
  group: ci-backend-${{ github.ref }}
  # Si entra una ejecución nueva del mismo grupo, cancela la anterior para ahorrar tiempo/recursos
  cancel-in-progress: true

# Conjunto de trabajos (jobs) que se ejecutan en el workflow
jobs:
  # ID del job (nombre interno)
  quality:
    # Nombre amigable que se muestra en GitHub Actions
    name: CI for QuickPass BackEnd (IngenioAPI)
    # Define el sistema operativo/runner donde corre el job
    runs-on: ubuntu-latest

    # Lista de pasos (steps) que se ejecutan en orden
    steps:
      # Paso: clona el repo en el runner para poder trabajar con el código
      - name: Checkout
        # Usa la action oficial para hacer checkout del código
        uses: actions/checkout@v4

      # Paso: instala/configura Node.js en el runner
      - name: Setup Node
        # Action oficial para instalar Node y configurar cache
        uses: actions/setup-node@v4
        with:
          # Fija la versión de Node a usar (Node 18)
          node-version: "18"
          # Habilita caché de npm para acelerar instalaciones en siguientes runs
          cache: "npm"

      # Paso: instala dependencias de forma limpia y reproducible
      - name: Install dependencies (npm ci)
        # npm ci instala exactamente lo que está en package-lock.json (ideal para CI)
        # --legacy-peer-deps evita fallos por conflictos de peer deps (común en algunos proyectos)
        run: npm ci --legacy-peer-deps

      # Comentario: tu script "format" escribe cambios, pero en CI solo validamos estilo
      # Paso: verifica formato con Prettier sin modificar archivos
      - name: Prettier check
        # npx ejecuta prettier sin necesitar instalación global
        # --check falla el job si encuentra archivos sin formato
        # Se revisan: src/**/*.ts, test/**/*.ts, y algunos archivos raíz (*.md, *.json)
        run: npx prettier --check "src/**/*.ts" "test/**/*.ts" "*.md" "*.json"

      # Comentario: tu script lint usa --fix (arregla solo), pero en CI NO queremos modificar
      # Comentario: se permite temporalmente hasta 100 warnings (mientras se limpia el código)
      # Paso: ejecuta ESLint y falla si pasa el límite de warnings (o si hay errors)
      - name: ESLint (max 100 warnings)
        # Lint en ts dentro de src, apps, libs y test
        # --max-warnings=100 permite hasta 100 warnings antes de fallar
        run: npx eslint "{src,apps,libs,test}/**/*.ts" --max-warnings=100
        
      # Comentario: paso de build
      # Paso: compila el proyecto (en Nest normalmente genera dist/ o salida de build)
      - name: Build
        # Ejecuta el script "build" definido en package.json
        run: npm run build
